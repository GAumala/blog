<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="JavaScript,ES6,Babel,webpack,Mithril,mithril.js,widget,button,tutorial">
    <meta name="description" content="Writing a like button with modern front-end development tools like Mithril, Babel and webpack." />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="Writing a like button with modern front-end development tools like Mithril, Babel and webpack.">
    <meta property="og:locale" content="es_US">
    <meta property="og:title" content="Building a Blog Part 3: Creating a Like button widget with Mithril and webpack">
    <meta property="og:description" content="Writing a like button with modern front-end development tools like Mithril, Babel and webpack.">
    <title>Building a Blog Part 3: Creating a Like button widget with Mithril and webpack</title>
    <link rel="stylesheet" href="../css/post-bundle.css" />
  </head>
  <body>
    <header>
      <nav>
        <a href="../" title="Home">
          <img id="home" src="../assets/images/home.svg" alt="Home"></a>
        <a href="../rss/posts.rss" title="RSS feed">
          <img class="icon-rss" src="../assets/images/rss.svg" alt="RSS"></a>
        <a href="https://twitter.com/gaumala987" title="Twitter profile">
          <img class="icon" src="../assets/images/twitter.svg" alt="Twitter"></a>
        <a href="https://github.com/GAumala" title="GitHub profile">
          <img class="icon" src="../assets/images/github.svg" alt="GitHub"></a>
      </nav>
    </header>

    <h1 class="post-title">Building a Blog Part 3: Creating a Like button widget with Mithril and webpack</h1>
    <div class="date"><span>September 25, 2018</span></div>
    <article>
      <section>
        <p>In part 3 of <a href="./posts/2018-09-03-is-this-finally-working-oh-hello-world.html">Building a Blog</a> I will talk about the implementation of the like button at the bottom of every post in this website. The goal is to have an interactive widget that lets users see the number of likes for the post they are currently reading and optionally increment it by one unit. It is written with <a href="https://mithril.js.org/">Mithril</a>, a modern JavaScript framework for fast <a href="https://en.wikipedia.org/wiki/Single-page_application">Single Page Applications</a>.</p>
<!--more-->
<h2 id="why-a-javascript-framework">Why a JavaScript framework?</h2>
<p>For a like button, A <code>button</code> inside a <code>form</code> certainly gets the job done with zero JavaScript, but there is a little problem. The page reloads every time the form submits a POST request, which is not the best user experience in this case. The better approach is to use <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">AJAX</a> so we are going to need at least a little JavaScript. On top of that, the button has a state, it is either pressed (you liked the post) or it isn’t. The button’s visual appearance and behavior changes depending on the state. Managing state is not a simple task so it’s better to use a tool that is designed to efficiently update the UI every time state changes.</p>
<h2 id="why-mithril">Why Mithril?</h2>
<p>From <a href="https://mithril.js.org/">Mithril’s homepage</a>:</p>
<blockquote>
<p>Mithril is a modern client-side Javascript framework for building Single Page Applications. It’s small (&lt; 8kb gzip), fast and provides routing and XHR utilities out of the box.</p>
</blockquote>
<p>As you can see, this fits perfectly in my blog since one of my goals is to keep the amount of JavaScript to a minimum to ensure faster page loading times. Doing an interactive button in plain old JavaScript is not something I consider maintainable because of the pain of dealing with state management. That’s the main reason why I decided to go with Mithril.</p>
<p>Whenever an event is triggered, Mithril automatically detects which parts of the UI need an update and efficiently re-renders those only. This same idea is implemented slightly differently by all popular front-end frameworks like React, Vue, Elm and many others. These frameworks have become so mainstream lately because they free you from having to write imperative code that manually calls DOM APIs to update the UI everytime somthing happens in your app.</p>
<p>I usually go with React for front-end applications, because it’s a great framework with a fantastic ecosystem, but for now I only want a small button. React is way too big for that. Mithril only adds 8 kB to the gzipped bundle size, instead of React’s 30+ kB. Also, inside those 8 kB there’s also a XHR utility included which helps with the AJAX calls. No need to add an extra library. On hindsight, <a href="https://preactjs.com/">Preact</a> would have probably been a better choice since it is only 3 kB and I don’t need Mithril’s routing. I will consider it for future projects, but I’m happy with Mithril so it stays in my blog.</p>
<h2 id="getting-started">Getting Started</h2>
<p>Like with most front-end development in 2018, the first step is to write some configuration files. This isn’t strictly necessary to get started with Mithril, but there are 2 things that I want that aren’t included out of the box:</p>
<ul>
<li>Transpilation of ECMAScript 6+ features and <a href="https://reactjs.org/docs/introducing-jsx.html">JSX</a> to ECMAScript 5, which is the JavaScript version that modern browsers can run without issues.</li>
<li>A development server that reloads pages everytime a source file changes.</li>
</ul>
<p>These things only improve the development experience. They don’t affect performance or user experience in any way, so if you are not interested you can skip this section.</p>
<p>Since I’m going to need <a href="https://babeljs.io/">Babel</a> and <a href="https://webpack.js.org/">webpack</a>, it is necessary to install a bunch of packages from the NPM registry. This can be achieved with <a href="https://yarnpkg.com/en/">yarn</a>:</p>
<pre><code>yarn add --dev babel-core babel-loader babel-plugin-transform-react-jsx babel-preset-env webpack webpack-cli webpack-dev-server</code></pre>
<p>My <code>package.json</code> file ends up like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="dt">&quot;babel-core&quot;</span><span class="fu">:</span> <span class="st">&quot;^6.26.3&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="dt">&quot;babel-loader&quot;</span><span class="fu">:</span> <span class="st">&quot;^7.1.5&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="dt">&quot;babel-plugin-transform-react-jsx&quot;</span><span class="fu">:</span> <span class="st">&quot;^6.24.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="dt">&quot;babel-preset-env&quot;</span><span class="fu">:</span> <span class="st">&quot;^1.7.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="dt">&quot;webpack&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.16.5&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    <span class="dt">&quot;webpack-cli&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.1.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="dt">&quot;webpack-dev-server&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.1.5&quot;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="fu">}</span></a></code></pre></div>
<p>Babel is the compiler that transforms whatever flavor of JavaScript you want to use into something that browsers can actually run. It is super extensible. First, you add <code>babel-core</code>, which contains the base compiler, and then you add a preset and some plugins that know how to transpile the syntax that you want to use into valid ES5. In this case I add <code>babel-preset-env</code>, which is a preset that transpiles ES6+ code, and <code>babel-plugin-transform-react-jsx</code>, which is a little plugin that transpiles JSX to components for any supported framework. To tell Babel to use these packages, I have the following <code>.babelrc</code> configuration file:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="dt">&quot;presets&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;env&quot;</span><span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="dt">&quot;plugins&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">        <span class="ot">[</span><span class="st">&quot;transform-react-jsx&quot;</span><span class="ot">,</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">            <span class="dt">&quot;pragma&quot;</span><span class="fu">:</span> <span class="st">&quot;m&quot;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">        <span class="fu">}</span><span class="ot">]</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="fu">}</span></a></code></pre></div>
<p>Transpilation by itself isn’t terribly useful in production environments. To optimize the page’s loading time, the generated code must be bundled into a single minified JS file that can be quickly sent over the network. This is where <code>webpack</code> comes in. Webpack is also very extensible. It can bundle pretty much any kind of file that you could possibly want to include in your web app. All you have to do is install the appropriate “loader” and use it in your config file. In this case I wanted webpack to transform my ES6 files with Babel before bundling them so I chose <code>babel-loader</code>. Since I’m going to be using webpack from a terminal, I also need <code>webpack-cli</code>. The last dependency is <code>webpack-dev-server</code>. This is used by webpack to spin up a small web server that serves the bundled JS and reloads the browser every time a source file changes and a new bundle is generated. My <code>webpack.config.js</code> file ends up being like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">'path'</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="dt">entry</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    <span class="dt">home</span><span class="op">:</span> <span class="st">'./src/home.index.js'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="dt">post</span><span class="op">:</span> <span class="st">'./src/post.index.js'</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="dt">output</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    <span class="dt">path</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">      __dirname<span class="op">,</span> </a>
<a class="sourceLine" id="cb4-11" data-line-number="11">      <span class="st">'./output/js'</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">    )<span class="op">,</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    <span class="dt">filename</span><span class="op">:</span> <span class="st">'[name].js'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="op">},</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="dt">module</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">    <span class="dt">rules</span><span class="op">:</span> [<span class="op">{</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">      <span class="dt">test</span><span class="op">:</span> <span class="ss">/</span><span class="sc">\.</span><span class="ss">js</span><span class="sc">$</span><span class="ss">/</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">      <span class="dt">exclude</span><span class="op">:</span> <span class="ss">/node_modules/</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">      <span class="dt">loader</span><span class="op">:</span> <span class="st">'babel-loader'</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    <span class="op">}</span>]</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  <span class="op">},</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">  <span class="dt">devServer</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    <span class="dt">contentBase</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">      __dirname<span class="op">,</span> </a>
<a class="sourceLine" id="cb4-25" data-line-number="25">      <span class="st">'../static/_site'</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">    )<span class="op">,</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27">    <span class="dt">publicPath</span><span class="op">:</span> <span class="st">'/js/'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">    <span class="dt">compress</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29">    <span class="dt">port</span><span class="op">:</span> <span class="dv">9000</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30">    <span class="dt">proxy</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31">      <span class="st">'/blogapi'</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32">        <span class="dt">target</span><span class="op">:</span> <span class="st">&quot;http://localhost:8008&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33">        <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span> </a>
<a class="sourceLine" id="cb4-34" data-line-number="34">          <span class="st">&quot;X-real-ip&quot;</span><span class="op">:</span> <span class="st">&quot;0.0.0.0&quot;</span> </a>
<a class="sourceLine" id="cb4-35" data-line-number="35">        <span class="op">},</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36">        <span class="dt">pathRewrite</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37">          <span class="st">'^/blogapi'</span> <span class="op">:</span> <span class="st">''</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39">      <span class="op">}</span></a>
<a class="sourceLine" id="cb4-40" data-line-number="40">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42"><span class="op">}</span></a></code></pre></div>
<p>This file specifies several things so I’ll try to explain them one by one.</p>
<ul>
<li>The <code>entry</code> section declares two entry points because there will be two bundles that will share some code: one for the posts page and another for the home page.</li>
<li>The <code>output</code> section declares that these two bundles will be generated at <code>output/js/post.js</code> and <code>output/js/home.js</code> respectively.</li>
<li>The <code>module</code> section adds a rule that says that every JS file must be transformed with Babel before bundling.</li>
<li>The <code>devServer</code> section configures the development server that I talked about earlier. It listens on port 9000 and serves all generated bundles as if they were actual files mounted and <code>/js/</code>. In addition to bundles, it also serves all the files in <code>../static/_site</code> which is <a href="./2018-09-07-generating-a-static-site-with-hakyll.html">where Hakyll outputs my static pages</a>. This allows me to try out my JS code on the actual pages of the blog. Finally, it proxies all <code>/blogapi</code> HTTP requests to <a href="./2018-09-12-creating-an-http-api-with-scotty-and-beam.html">my API Server</a>, rewriting the path and adding extra headers so that they can be processed correctly just like if they had been forwarded by Nginx in production. This lets me verify that the button is using the endpoints correctly.</li>
</ul>
<p>Now that the tools are properly configured all that’s left to do is to actually run them. In development, webpack should start the dev server and generate bundles as quickly as possible, without any optimizations, and include source maps so that they can debugged. Luckily, the <a href="https://webpack.js.org/api/cli/#shortcuts"><code>-d</code> flag</a> is a shortcut that does just that:</p>
<pre><code>yarn webpack-dev-server -d</code></pre>
<p>For production, the bundle should be minified and optimized. The <a href="https://webpack.js.org/api/cli/#shortcuts"><code>-p</code> flag</a> is another nice shortcut that gets the job done:</p>
<pre><code>yarn webpack -p</code></pre>
<h2 id="writing-the-widget">Writing the widget</h2>
<p>Once configuration is done, I can actually write the code for my widget. It consumes the endpoints created in part 2, so let’s add the functions for the AJAX calls:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="im">import</span> m <span class="im">from</span> <span class="st">&quot;mithril&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="im">import</span> <span class="op">{</span>postStringId<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;./browser.js&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="im">export</span> <span class="kw">const</span> incrementLikesCount <span class="op">=</span> () <span class="op">=&gt;</span>  <span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="cf">return</span> <span class="va">m</span>.<span class="at">request</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="dt">url</span><span class="op">:</span> <span class="vs">`/blogapi/like/</span><span class="sc">${</span>postStringId<span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="im">export</span> <span class="kw">const</span> getLikesCount <span class="op">=</span> () <span class="op">=&gt;</span> </a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  <span class="va">m</span>.<span class="at">request</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    <span class="dt">url</span><span class="op">:</span> <span class="vs">`/blogapi/likes/</span><span class="sc">${</span>postStringId<span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  <span class="op">}</span>)</a></code></pre></div>
<p><code>postStringId</code> is just a helper function that extracts the post’s ID from the URL. These 2 functions use Mithril’s <a href="https://mithril.js.org/#xhr"><code>request</code> function</a> which returns <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">a promise</a> that resolves to the server response without the need for a promise polyfill. As you can see, it is very easy to do asynchronous HTTP requests with Mithril.</p>
<p>The widget will be handled by the <code>app</code> function. The idea is to display 3 things: the button, a counter with the post’s number of likes and a little message to inform the user about the button. The first thing that I will do here is to declare my state.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">const</span> app <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="kw">let</span> liked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="kw">let</span> likesCount <span class="op">=</span> <span class="st">&quot;??&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="kw">let</span> lastCountFromServer <span class="op">=</span> likesCount<span class="op">;</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="kw">let</span> footerMsg <span class="op">=</span> <span class="st">&quot;If you liked this post, please hit this like button to show your appreciation.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="co">// rest of the function...</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="op">}</span></a></code></pre></div>
<p>The first variable <code>liked</code> is self-explanatory, the post is either liked or not. The widget will be gray at start but red after being liked. <code>likesCount</code> is the “number” of likes to show in the counter. It starts with “??” because this value has to be fetched via AJAX, so it is unknown until the response arrives. <code>lasCountFromServer</code> holds the last value of <code>likesCount</code>. This is handy for “rollbacks” whenever an error is thrown. Finally <code>footerMsg</code> is a message to display next to the button. It first invites the user to like the post and when an error occurs this can be used to show an error message.</p>
<p>Now that state is declared let’s add some functions to manipulate it.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">const</span> app <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="kw">let</span> liked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw">let</span> likesCount <span class="op">=</span> <span class="st">&quot;??&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="kw">let</span> lastCountFromServer <span class="op">=</span> likesCount<span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  <span class="kw">let</span> footerMsg <span class="op">=</span> <span class="st">&quot;If you liked this post, please hit this like button to show your appreciation.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="kw">const</span> updateLikesCounter <span class="op">=</span> newValue <span class="op">=&gt;</span> <span class="op">{</span> </a>
<a class="sourceLine" id="cb9-8" data-line-number="8">    likesCount <span class="op">=</span> newValue<span class="op">;</span> </a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    lastCountFromServer <span class="op">=</span> newValue<span class="op">;</span> </a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="kw">const</span> undoLike <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    liked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">    likesCount <span class="op">=</span> lastCountFromServer<span class="op">;</span>  </a>
<a class="sourceLine" id="cb9-15" data-line-number="15">    footerMsg <span class="op">=</span> <span class="st">&quot;Oops! Something went wrong. Please try again in a few seconds.&quot;</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="kw">const</span> onCreateLikeButton <span class="op">=</span> () <span class="op">=&gt;</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">    <span class="at">getLikesCount</span>().<span class="at">then</span>(updateLikesCounter<span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{}</span>)</a>
<a class="sourceLine" id="cb9-20" data-line-number="20"></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">  <span class="kw">const</span> onLikeButtonClicked <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span> </a>
<a class="sourceLine" id="cb9-22" data-line-number="22">    liked <span class="op">=</span> <span class="kw">true</span><span class="op">;</span> </a>
<a class="sourceLine" id="cb9-23" data-line-number="23">    <span class="cf">if</span> (<span class="kw">typeof</span> likesCount <span class="op">==</span> <span class="st">&quot;number&quot;</span>) </a>
<a class="sourceLine" id="cb9-24" data-line-number="24">      likesCount <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25"></a>
<a class="sourceLine" id="cb9-26" data-line-number="26">    <span class="at">incrementLikesCount</span>()</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">      .<span class="at">then</span>(newValue <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28">        <span class="at">updateLikesCounter</span>(newValue)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29">        footerMsg <span class="op">=</span> <span class="st">&quot;Thank you!&quot;</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30">      <span class="op">}</span>)</a>
<a class="sourceLine" id="cb9-31" data-line-number="31">      .<span class="at">catch</span>(undoLike)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33"></a>
<a class="sourceLine" id="cb9-34" data-line-number="34">  <span class="co">// rest of the function...</span></a>
<a class="sourceLine" id="cb9-35" data-line-number="35"><span class="op">}</span></a></code></pre></div>
<p><code>onCreateLikeButton</code> and <code>onLikeButtonCliked</code> are the only functions that get called by the component, the other ones are just helpers.</p>
<p>When the component is created, <code>onCreateLikeButton</code> gets called and it sends an HTTP request to get the current like count for that post from the server. If the request succeeds, both <code>likesCount</code> and <code>lastCountFromServer</code> get updated with the new value. If the request fails then nothing is done.</p>
<p>When the button is clicked, then the button sends the HTTP request to update the likes counter in the server. The button is optimistic, it assumes that the request will succeed so it immediately sets <code>liked</code> to true and tries to update the in-memory counter. If the request succeeds then the counter is updated to whatever value the server currently has and sets <code>footerMsg</code> to a thank you message. If it fails, then the button has to rollback the optimistic update and set <code>footerMsg</code> to an error message. This is the whole point of keeping <code>lastCountFromServer</code>, so that the component can quickly return to that value when things go wrong.</p>
<p>Notice how there is no special API to update the component’s state like React’s <code>setState</code>. After every event, Mithril runs the callbacks and then figures out which parts in the UI actually changed and re-renders them.</p>
<p>The only thing left to do in the <code>app</code> function is to return a component. Every component must expose a <code>view</code> method and optionally other functions for lifecycle events or <em>hooks</em>. In this case I only need the <code>oncreate</code> hook to load the post’s like count so this is what <code>app</code> returns:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="cf">return</span> (<span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="dt">oncreate</span><span class="op">:</span> onCreateButton<span class="op">,</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="dt">view</span><span class="op">:</span> () <span class="op">=&gt;</span> </a>
<a class="sourceLine" id="cb10-4" data-line-number="4">      <span class="op">&lt;</span>table className<span class="op">=</span><span class="st">&quot;like-footer&quot;</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">        <span class="op">&lt;</span>tr<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">          <span class="op">&lt;</span>td className<span class="op">=</span><span class="st">&quot;like-me&quot;</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">            <span class="op">&lt;</span>LikeCounter liked<span class="op">={</span>liked<span class="op">}</span> likesCount<span class="op">={</span>likesCount<span class="op">}</span>/&gt;</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">            <span class="op">&lt;</span>LikeButton liked<span class="op">={</span>liked<span class="op">}</span> </a>
<a class="sourceLine" id="cb10-9" data-line-number="9">              onLikeButtonClicked<span class="op">={</span>liked <span class="op">?</span> <span class="kw">null</span> : onLikeButtonClicked<span class="op">}</span>/&gt;</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">          &lt;/td<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">          <span class="op">&lt;</span>td className<span class="op">=</span><span class="st">&quot;pls-like&quot;</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">            <span class="op">&lt;</span>em<span class="op">&gt;{</span>footerMsg<span class="op">}</span>&lt;/em<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">          &lt;/td<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">        &lt;/tr<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">      &lt;/table<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="op">}</span>)</a></code></pre></div>
<p>JSX can be used in the <code>view</code> function so that it can resemble the HTML that is generated on the browser. This function just returns a table with one row and two columns. The button and counter go on the first column and the message contained in <code>footerMsg</code> goes in the second column. The state variables <code>liked</code> and <code>likesCount</code> are passed to the smaller components <code>LikeButton</code> and <code>LikeCounter</code> as attributes. Notice that the <code>onLikeButtonClicked</code> callback is only set if the button is not already liked to avoid unnecessary actions. Here’s the code for the rest of the components:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">const</span> LikeCounter <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="dt">view</span><span class="op">:</span> (<span class="op">{</span> <span class="dt">attrs</span><span class="op">:</span> <span class="op">{</span> liked<span class="op">,</span> likesCount <span class="op">}</span> <span class="op">}</span>) <span class="op">=&gt;</span> </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">    <span class="op">&lt;</span>div id<span class="op">=</span><span class="st">&quot;like-count&quot;</span> className<span class="op">={</span>liked <span class="op">?</span> <span class="st">&quot;liked&quot;</span> : <span class="st">&quot;&quot;</span><span class="op">}&gt;</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      <span class="op">{</span>likesCount<span class="op">}</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    &lt;/div<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">const</span> LikeButton <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">  <span class="dt">view</span><span class="op">:</span> (<span class="op">{</span> <span class="dt">attrs</span><span class="op">:</span> <span class="op">{</span> liked<span class="op">,</span> onLikeButtonClicked <span class="op">}</span> <span class="op">}</span>) <span class="op">=&gt;</span> </a>
<a class="sourceLine" id="cb11-10" data-line-number="10">    <span class="op">&lt;</span>div id<span class="op">=</span><span class="st">&quot;heart&quot;</span> </a>
<a class="sourceLine" id="cb11-11" data-line-number="11">      style<span class="op">={</span>liked <span class="op">?</span> <span class="op">{</span><span class="dt">backgroundPosition</span><span class="op">:</span> <span class="st">&quot;right&quot;</span><span class="op">}</span> : <span class="kw">null</span><span class="op">}</span> </a>
<a class="sourceLine" id="cb11-12" data-line-number="12">      className<span class="op">={</span>liked <span class="op">?</span> <span class="st">&quot;heart-animation&quot;</span> : <span class="st">&quot;&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">      onclick<span class="op">={</span>onLikeButtonClicked<span class="op">}&gt;</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14">    &lt;/div<span class="op">&gt;</span> </a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="op">}</span></a></code></pre></div>
<p>These two take the data passed by the parent from the <code>attrs</code> object in <code>view</code>’s only argument and use it to render the DOM elements accordingly. Finally, to add the widget to the page, the <code>app</code> function must be mounted:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" data-line-number="1">  <span class="kw">const</span> e <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;my-like-widget&quot;</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="va">m</span>.<span class="at">mount</span>(e<span class="op">,</span> app)<span class="op">;</span></a></code></pre></div>
<p>And that’s it! There is no need to mess with DOM APIs like <code>createElement</code>, <code>findElementById</code>, <code>innerText</code>, or <code>innerHTML</code>, the framework takes care of all that. After creating the production bundle with webpack, the widget is ready to be served. For that matter I use Nginx. Next part will be about configuring Nginx to serve static files efficiently and proxy API requests correctly.</p>
      </section>
    </article>

    <div class="footer-separator"></div>
    <div id="like-footer"></div>
    <script src="../js/post.js"></script>
  </body>
</html>
